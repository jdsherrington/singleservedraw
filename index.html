<!doctype html>
<html>
  <head>
    <title>Item Distributor - Create</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
  </head>
  <body>
    <p>Enter a list of items â€” each visitor gets one at random.</p>
    <textarea
      id="items"
      rows="10"
      cols="50"
      placeholder="One item per line"
    ></textarea
    ><br />
    <button id="generate">Generate Link</button>
    <p id="link"></p>
    <span id="author">Created by JDSherrington</span>

    <script>
      const client = window.supabase.createClient(
        "https://bwkdtnbjefmphmrtftup.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3a2R0bmJqZWZtcGhtcnRmdHVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDM1OTQsImV4cCI6MjA3MDU3OTU5NH0.K8w87ZaKcO3EyP6ppzGXLBIqgZcIaB4dL2S0zVmS1Cg",
      );

      document
        .getElementById("generate")
        .addEventListener("click", async () => {
          const lines = document
            .getElementById("items")
            .value.split("\n")
            .map((l) => l.trim())
            .filter((l) => l);

          if (!lines.length) {
            alert("Please enter at least one item.");
            return;
          }

          // 1. Create set
          const { data: setData, error: setError } = await client
            .from("item_sets")
            .insert([{}])
            .select()
            .single();

          if (setError) {
            alert(setError.message);
            return;
          }

          // 2. Insert items
          const itemsToInsert = lines.map((value) => ({
            set_id: setData.id,
            value,
          }));

          const { error: itemsError } = await client
            .from("items")
            .insert(itemsToInsert);

          if (itemsError) {
            alert(itemsError.message);
            return;
          }

          const link = `${window.location.origin}/set.html?id=${setData.id}`;
          document.getElementById("link").innerHTML =
            `<a href="${link}">${link}</a>`;
          document.getElementById("generate").style.display = "none";
        });
    </script>
  </body>
</html>
